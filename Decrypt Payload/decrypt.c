#include <Windows.h>
#include <stdio.h>
#include "CtAes.h"

// COPY AND PASTE ENCRYPT.EXE OUTPUT HERE
//
// CHANGE EACH BRUTE FORCE DECRYPT TO KEY AND IV ALIKE
//
// BruteForceDecryptionKey()
// BruteForceDecryptionIv()
//
// I USE THIS FASHION OF DECRYPTING IN MEMORY A LOT, REMEMBER, THE BUFFER IS IN MEMORY READY TO USE

BOOL InstallAesDecryptionViaCtAes(IN PBYTE pCipherTextBuffer, IN SIZE_T sCipherTextSize, IN PBYTE pAesKey, IN PBYTE pAesIv, OUT PBYTE* ppPlainTextBuffer, OUT SIZE_T* pPlainTextSize) {

    AES256_CBC_ctx	AesCtx = { 0x00 };

    if (!pCipherTextBuffer || !sCipherTextSize || !ppPlainTextBuffer || !pAesKey || !pAesIv)
        return FALSE;

    if (!(*ppPlainTextBuffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sCipherTextSize))) {
        printf("[!] HeapAlloc Failed With Error: %d \n", GetLastError());
        return FALSE;
    }

    RtlSecureZeroMemory(&AesCtx, sizeof(AES256_CBC_ctx));
    AES256_CBC_init(&AesCtx, pAesKey, pAesIv);
    AES256_CBC_decrypt(&AesCtx, (sCipherTextSize / 16), *ppPlainTextBuffer, pCipherTextBuffer);

    *pPlainTextSize = sCipherTextSize;

    return TRUE;
}

void PrintHexString(const unsigned char* buffer, size_t bufferSize) {
    for (size_t i = 0; i < bufferSize; ++i) {
        if (i % 16 == 0) {
            if (i > 0) {
                printf("\"\n");
            }
            printf("\"");
        }
        printf("\\x%02x", buffer[i]);
    }
    printf("\";\n");
}

int main() {

    PBYTE DecryptedShellcode = NULL;
    SIZE_T DecryptedSize = 0;

    BruteForceDecryptionKey(AesKey, 32);
    BruteForceDecryptionIv(AesIv, 16);

    if (!InstallAesDecryptionViaCtAes(Shellcode, sizeof(Shellcode), AesKey, AesIv, &DecryptedShellcode, &DecryptedSize)) {
        return -1;
    }

    PrintHexString(DecryptedShellcode, DecryptedSize);

}
